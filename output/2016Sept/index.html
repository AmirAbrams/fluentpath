<!DOCTYPE html>
<!-- saved from url=(0043)http://hl7.org/fhir/2016May/fluentpath.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <title>FluentPath (STU1 Ballot)</title>

  
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="http://hl7.org/fhir" name="author">

  <link rel="stylesheet" href="../dist/fhir.css">
  <link rel="Prev" href="http://hl7.org/fhir/fluentpath.html">

    <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="../dist/bootstrap.css">
  <link rel="stylesheet" href="../dist/bootstrap-fhir.css">

    <!-- Project extras -->
  <link rel="stylesheet" href="../dist/project.css">
  <link rel="stylesheet" href="../dist/pygments-manni.css">
	<link rel="stylesheet" href="../dist/jquery-ui.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- [if lt IE 9]>
  <script src="./assets/js/html5shiv.js"></script>
  <script src="./assets/js/respond.min.js"></script>
  <![endif] -->

    <!-- Favicons -->
  <link sizes="144x144" rel="apple-touch-icon-precomposed" href="http://hl7.org/fhir/2016May/assets/ico/apple-touch-icon-144-precomposed.png">
  <link sizes="114x114" rel="apple-touch-icon-precomposed" href="http://hl7.org/fhir/2016May/assets/ico/apple-touch-icon-114-precomposed.png">
  <link sizes="72x72" rel="apple-touch-icon-precomposed" href="http://hl7.org/fhir/2016May/assets/ico/apple-touch-icon-72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="http://hl7.org/fhir/2016May/assets/ico/apple-touch-icon-57-precomposed.png">
  <link rel="shortcut icon" href="http://hl7.org/fhir/2016May/assets/ico/favicon.png">
  
</head>
<body data-feedly-mini="yes">
	<div id="segment-header" class="segment">  <!-- segment-header -->	
		<div class="container">  <!-- container -->
			<a id="logo" no-external="true" href="http://hl7.org/fhir"><img alt="logo fhir" src="../dist/fhir-logo-www.png"> </a>
			<div id="hl7-status">
				<b>FluentPath STU1 Ballot</b>
			</div>       	
			
			<div id="hl7-nav">
				 <a id="hl7-logo" no-external="true" href="http://www.hl7.org/">
					<img height="50" alt="visit the hl7 website" width="42" src="../dist/hl7-logo.png">
				</a> 
			</div>       	
			<div id="hl7-nav"><a id="hl7-logo" no-external="true" href="http://hl7.org/fhir/search.cfm"><img alt="Search FHIR" src="../dist/search.png"></a></div> 
		</div>
		<div class="container">  <!-- container -->
	</div></div>  <!-- /segment-header -->	

	<div id="segment-navbar" class="segment">  <!-- segment-navbar -->
		<div id="stripe"> </div>
		<div class="container">  <!-- container -->
   <!-- HEADER CONTENT -->
 	      		
 	      		      		
			<nav class="navbar navbar-inverse">
				<div class="container">
					<button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
						<span class="icon-bar"> </span>
						<span class="icon-bar"> </span>
						<span class="icon-bar"> </span>
					</button>
					<a class="navbar-brand hidden" href="index.html">FluentPath</a>
					<div class="nav-collapse collapse navbar-inverse-collapse">
						<ul class="nav navbar-nav">
              <li><a href="index.html">Documentation</a></li>
              <li><a href="grammar.html">Grammar</a></li>
              <li><a href="tests.html">Tests</a></li>
              <li><a href="../history.html">Version History</a></li>

						</ul>
					</div>  <!-- /.nav-collapse -->

          </div>  <!-- /.container -->
			</nav>  <!-- /.navbar -->
      		
				
  <!-- /HEADER CONTENT -->				
		</div>  <!-- /container -->
	</div>  <!-- /segment-navbar -->
	
	<div id="segment-content" class="segment">  <!-- segment-content -->
	<div class="container">  <!-- container -->
            <div class="row">
            	<div class="inner-wrapper">
  <!-- CONTENT CONTENT -->


<div class="col-9">
    
<h1>FluentPath (STU1 Ballot)</h1>
    
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>FluentPath is a path based navigation and extraction language, somewhat like XPath. Operations are expressed in terms of the logical content of hierarchical data models, and support traversal, selection and filtering of data. Its design was influenced by the needs for path navigation, selection and formulation of invariants in both HL7 Fast Healthcare Interoperability Resources (FHIR) and HL7 Clinical Quality Language (CQL).</p>
</div>
<div class="paragraph">
<p>Version 0.3 Public Domain (Creative Commons 0)</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">1. Overview</a>
<ul class="sectlevel2">
<li><a href="#requirements">1.1. Requirements</a></li>
<li><a href="#features">1.2. Features</a></li>
<li><a href="#usage">1.3. Usage</a></li>
<li><a href="#conventions">1.4. Conventions</a></li>
</ul>
</li>
<li><a href="#navigation-model">2. Navigation model</a></li>
<li><a href="#path-selection">3. Path selection</a>
<ul class="sectlevel2">
<li><a href="#collections">3.1. Collections</a></li>
<li><a href="#paths-and-polymorphic-items">3.2. Paths and polymorphic items</a></li>
<li><a href="#referring-to-the-current-item">3.3. Referring to the current item</a></li>
<li><a href="#order-nodes-and-traversal">3.4. Order nodes and traversal</a></li>
</ul>
</li>
<li><a href="#expressions">4. Expressions</a>
<ul class="sectlevel2">
<li><a href="#literals">4.1. Literals</a></li>
<li><a href="#operators">4.2. Operators</a></li>
<li><a href="#functions">4.3. Functions</a></li>
<li><a href="#null-and-empty">4.4. Null and empty</a></li>
<li><a href="#boolean-evaluation-of-collections">4.5. Boolean evaluation of collections</a></li>
<li><a href="#propagation-of-empty-results">4.6. Propagation of empty results</a></li>
</ul>
</li>
<li><a href="#functions-2">5. Functions</a>
<ul class="sectlevel2">
<li><a href="#existence">5.1. Existence</a></li>
<li><a href="#filtering-and-projection">5.2. Filtering and projection</a></li>
<li><a href="#subsetting">5.3. Subsetting</a></li>
<li><a href="#conversion">5.4. Conversion</a></li>
<li><a href="#string-manipulation">5.5. String Manipulation</a></li>
<li><a href="#tree-navigation">5.6. Tree navigation</a></li>
<li><a href="#utility-functions">5.7. Utility functions</a></li>
</ul>
</li>
<li><a href="#operations">6. Operations</a>
<ul class="sectlevel2">
<li><a href="#equality">6.1. Equality</a></li>
<li><a href="#comparison">6.2. Comparison</a></li>
<li><a href="#types">6.3. Types</a></li>
<li><a href="#collections-2">6.4. Collections</a></li>
<li><a href="#boolean-logic">6.5. Boolean logic</a></li>
<li><a href="#math">6.6. Math</a></li>
<li><a href="#date-time-arithmetic">6.7. Date/Time Arithmetic</a></li>
<li><a href="#operator-precedence">6.8. Operator precedence</a></li>
</ul>
</li>
<li><a href="#environment-variables">7. Environment variables</a></li>
<li><a href="#reflection">8. Reflection</a></li>
<li><a href="#type-safety-and-strict-evaluation">9. Type safety and strict evaluation</a></li>
<li><a href="#formal-syntax">Appendix A: Formal Syntax</a></li>
<li><a href="#use-of-fluentpath-in-hl7-fhir">Appendix B: Use of FluentPath in HL7 FHIR</a>
<ul class="sectlevel2">
<li><a href="#polymorphism-in-fhir">B.1. Polymorphism in FHIR</a></li>
<li><a href="#using-fhir-types-in-expressions">B.2. Using FHIR types in expressions</a></li>
<li><a href="#additional-functions">B.3. Additional functions</a></li>
<li><a href="#changes-to-operators">B.4. Changes to operators</a></li>
<li><a href="#environment-variables-2">B.5. Environment variables</a></li>
</ul>
</li>
<li><a href="#use-of-fluentpath-in-clinical-quality-language-cql">Appendix C: Use of FluentPath in Clinical Quality Language (CQL)</a>
<ul class="sectlevel2">
<li><a href="#path-traversal">C.1. Path Traversal</a></li>
<li><a href="#constants-and-contexts">C.2. Constants and Contexts</a></li>
<li><a href="#additional-operators">C.3. Additional Operators</a></li>
<li><a href="#method-style-invocation">C.4. Method-style Invocation</a></li>
<li><a href="#strict-evaluation">C.5. Strict Evaluation</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Information Systems in general, and Healthcare Information Systems in particular, the need for formal representation of logic is both pervasive and critical. From low-level technical specifications, through intermediate logical architectures, up to the high-level conceptual descriptions of requirements and behavior, the ability to formally represent knowledge in terms of expressions and information models is essential to the specification and implementation of these systems.</p>
</div>
<div class="sect2">
<h3 id="requirements">1.1. Requirements</h3>
<div class="paragraph">
<p>Of particular importance is the ability to easily and precisely express conditions of basic logic, such as those found in requirements constraints (e.g. Patients must have a name), decision support (e.g. if the patient has diabetes and has not had a recent comprehensive foot exam), cohort definitions (e.g. All male patients aged 60-75), protocol descriptions (e.g. if the specimen has tested positive for the presence of sodium), and numerous other environments.</p>
</div>
<div class="paragraph">
<p>Precisely because the need for such expressions is so pervasive, there is no shortage of existing languages for representing them. However, these languages tend to be tightly coupled to the data structures, and even the information models on which they operate, XPath being a typical example. To ensure that the knowledge captured by the representation of these expressions can survive technological drift, a representation that can be used independent of any underlying physical implementation and information model is required.</p>
</div>
<div class="paragraph">
<p>Languages meeting these additional requirements also exist, such as Java, JavaScript, C#, and others. However, these languages are both tightly coupled to the platforms in which they operate, and, because they are general-purpose development languages, come with much heavier tooling and technology dependencies than is warranted or desirable.</p>
</div>
<div class="paragraph">
<p>Given these constraints, and the lack of a specific language that meets all of these requirements, there is a need for a simple, lightweight, platform- and structure-independent graph traversal language. FluentPath meets these requirements, and can be used within various environments to provide for simple but effective formal representation of expressions.</p>
</div>
</div>
<div class="sect2">
<h3 id="features">1.2. Features</h3>
<div class="ulist">
<ul>
<li>
<p>Graph-traversal: FluentPath is a graph-traversal language; authors can clearly and concisely express graph traversal on hierarchical information models (e.g. HL7 V3, FHIR, vMR, CIMI, and QDM).</p>
</li>
<li>
<p>Collection-centric: FluentPath deals with all values as collections, allowing it to easily deal with information models with repeating elements.</p>
</li>
<li>
<p>Platform-independent: FluentPath is a conceptual and logical specification that can be implemented in any platform.</p>
</li>
<li>
<p>Model-independent: FluentPath deals with data as an abstract model, allowing it to be used with any information model.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="usage">1.3. Usage</h3>
<div class="paragraph">
<p>In Fast Healthcare Interoperability Resources (FHIR), FluentPath is used within the specification to provide formal definitions for conditions such as validation invariants, search parameter paths, etc. Within Clinical Quality Language (CQL), FluentPath is used to simplify graph-traversal for hierarchical information models.</p>
</div>
<div class="paragraph">
<p>In both FHIR and CQL, the model independence of FluentPath means that expressions can be written that deal with the contents of the resources and data types as described in the Logical views, or the UML diagrams, rather than against the physical representation of those resources. JSON and XML specific features are not visible to the FluentPath language (such as comments and the split representation of primitives (i.e. <code>value[x]</code>)).</p>
</div>
<div class="paragraph">
<p>The expressions can in theory be converted to equivalent expressions in XPath, OCL, or another similarly expressive language.</p>
</div>
</div>
<div class="sect2">
<h3 id="conventions">1.4. Conventions</h3>
<div class="paragraph">
<p>Throughout this documentation, <code>monospace font</code> is used to delineate expressions of FluentPath.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="navigation-model">2. Navigation model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FluentPath navigates and selects nodes from a tree that abstracts away and is independent of the actual underlying implementation of the source against which the FluentPath query is run. This way, FluentPath can be used on in-memory Java POJOs, Xml data or any other physical representation, so long as that representation can be viewed as classes that have properties. In somewhat more formal terms, FluentPath operates on a directed acyclic graph of classes as defined by a MOF-equivalent type system.</p>
</div>
<div class="paragraph">
<p>Data is represented as a tree of labelled nodes, where each node may optionally carry a primitive value and have child nodes. Nodes need not have a unique label, and leaf nodes must carry a primitive value. For example, a (partial) representation of a FHIR Patient resource in this model looks like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="treestructure.png" alt="Tree representation of a Patient"></span></p>
</div>
<div class="paragraph">
<p>The diagram shows a tree with a repeating <code>name</code> node, which represents repeating members of the FHIR object model. Leaf nodes such as <code>use</code> and <code>family</code> carry a (string) value. It is also possible for internal nodes to carry a value, as is the case for the node labelled <code>active</code>: this allows the tree to represent FHIR "primitives", which may still have child extension data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="path-selection">3. Path selection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FluentPath allows navigation through the tree by composing a path of concatenated labels, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>name.given</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would result in a collection of nodes, one with the value "Wouter" and one with the value "Gert". In fact, each step in such a path results in a collection of nodes by selecting nodes with the given label from the step before it. The focus at the beginning of the evaluation contained all elements from Patient, and the path <code>name</code> selected just those named <code>name</code>. Since the <code>name</code> element repeats, the next step <code>given</code> along the path, will contain all nodes labeled <code>given</code> from all nodes <code>name</code> in the preceding step.</p>
</div>
<div class="paragraph">
<p>The path may start with the type of the root node (which otherwise does not have a name), but this is optional. To illustrate this point, the path <code>name.given</code> above can be evaluated as an expression on a set of data of any type. However the expression may be prefixed with the name of the type of the root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two expressions have the same outcome, but when evaluating the second, the evaluation will only produce results when used on data of type <code>Patient</code>.</p>
</div>
<div class="paragraph">
<p>Syntactically, FluentPath defines identifiers as any sequence of characters consisting only of letters, digits, and underscores, beginning with a letter or underscore. Paths may use double quotes to include characters in path parts that would otherwise be interpreted as keywords or operators, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Message."PID-1"</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="collections">3.1. Collections</h3>
<div class="paragraph">
<p>Collections are fundamental to FluentPath, in that the result of every expression is a collection, even if that expression only results in a single element. This approach allows paths to be specified without having to care about the cardinality of any particular element, and is therefore ideally suited to graph traversal.</p>
</div>
<div class="paragraph">
<p>Within FluentPath, a collection is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ordered - The order of items in the collection is important and is preserved through operations as much as possible.</p>
</li>
<li>
<p>Non-Unique - Duplicate elements are allowed within a collection. Some functions, such as <code>distinct()</code> and <code>union()</code> produce collections of unique elements, but in general, duplicate elements are allowed.</p>
</li>
<li>
<p>Indexed - Each item in a collection can be uniquely addressed by it&#8217;s index, i.e. ordinal position within the collection</p>
</li>
<li>
<p>Countable - The number of items in a given collection can always be determined using the <code>count()</code> function</p>
</li>
<li>
<p>0-based - The first item in a collection has index 0</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="paths-and-polymorphic-items">3.2. Paths and polymorphic items</h3>
<div class="paragraph">
<p>In the underlying representation of data, nodes may be typed and represent polymorphic items. Paths may either ignore the type of a node, and continue along the path or may be explicit about the expected node and filter the set of nodes by type before navigating down child nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Observation.value.unit - all kinds of value
Observation.value.as(Quantity).unit - only values that are of type Quantity</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>is</code> function can be used to determine whether or not a given value is of a given type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Observation.value.is(Quantity) - returns true if the value is of type Quantity</code></pre>
</div>
</div>
<div class="paragraph">
<p>The list of available types that can be passed as a parameter to the <code>as</code> and <code>is</code> functions is determined by the underlying data model.</p>
</div>
</div>
<div class="sect2">
<h3 id="referring-to-the-current-item">3.3. Referring to the current item</h3>
<div class="paragraph">
<p>It is sometimes useful to refer to the current item under evaluation when writing an expression, especially within operations like <code>where()</code> when the value of the current item needs to be passed as a function parameter. This can be done using the special path <code>$this</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given.where(substring($this.length()-3)) = "out"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="order-nodes-and-traversal">3.4. Order nodes and traversal</h3>
<div class="paragraph">
<p>Collections in FluentPath are inherently ordered, and implementations must retain the original order of a collection. There are two special cases: the outcome of operations like <code>children()</code> and <code>descendants()</code> cannot be assumed to be in any meaningful order, and <code>first()</code>, <code>last()</code>, <code>tail()</code>, <code>skip()</code> and <code>take()</code> should not be used on collections derived from these paths. Note that some implementations may follow the logical order implied by the data model, and some may not, and some may be different depending on the underlying source.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expressions">4. Expressions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="literals">4.1. Literals</h3>
<div class="paragraph">
<p>In addition to paths, FluentPath expressions may contain <em>literals</em> and <em>function invocations</em>. FluentPath supports the following types of literals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>boolean: true, false
string: 'test string', 'urn:oid:3.4.5.6.7.8'
integer: 0, 45
decimal: 0.0, 3.141592653587793236
datetime: @2015-02-04T14:34:28Z (`@` followed by ISO8601 compliant date/time)
time: @T14:34:28+09:00 (`@` followed by ISO8601 compliant time beginning with `T`)
quantity: 10 'mg', 4 days</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="string">4.1.1. string</h4>
<div class="paragraph">
<p>Unicode is supported in both string literals and quoted identifiers. String literals are surrounded by single quotes and may use <code>\</code>-escapes to escape quotes and represent Unicode characters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unicode characters may be escaped using <code>\u</code> followed by four hex digits.</p>
</li>
<li>
<p>Additional escapes are those supported in JSON:</p>
<div class="ulist">
<ul>
<li>
<p><code>\\</code> (backslash),</p>
</li>
<li>
<p><code>\/</code> (slash),</p>
</li>
<li>
<p><code>\f</code> (form feed - \u000c),</p>
</li>
<li>
<p><code>\n</code> (newline - \u000a),</p>
</li>
<li>
<p><code>\r</code> (carriage return - \u000d),</p>
</li>
<li>
<p><code>\t</code> (tab - \u0009)</p>
</li>
<li>
<p><code>&amp;quot;</code> (double quote)</p>
</li>
<li>
<p><code>&amp;#39;</code> (single quote)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="decimal">4.1.2. decimal</h4>
<div class="paragraph">
<p>Decimals cannot use exponential notation.</p>
</div>
</div>
<div class="sect3">
<h4 id="datetime">4.1.3. datetime</h4>
<div class="paragraph">
<p><code>datetime</code> uses a subset of ISO8601:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It used the YYYY-MM-DD format, though month and days may be left out</p>
</li>
<li>
<p>Week dates and ordinal dates are not allowed</p>
</li>
<li>
<p>Years must be present (–MM-DD is not used)</p>
</li>
<li>
<p>Months must be present if a day is present</p>
</li>
<li>
<p>The date may be followed by a <code>time</code> as described in the next section.</p>
</li>
<li>
<p>Consult the formal grammar for more details.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="time">4.1.4. time</h4>
<div class="paragraph">
<p><code>time</code> uses a subset of ISO8601:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A time begins with a <code>T</code></p>
</li>
<li>
<p>Timezone is optional, but if present the notation "±hh:mm" is used (so must include both minutes and hours)</p>
</li>
<li>
<p><code>Z</code> is allowed for the zero UTC offset.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consult the formal grammar for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="quantity">4.1.5. quantity</h4>
<div class="paragraph">
<p><code>quantity</code> is a number (integer or decimal), followed by a valid <a href="http://unitsofmeasure.org/trac">Unified Code for Units of Measure (UCUM)</a> unit, expressed as a string, or a date/time unit, plural or singular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>year, years</p>
</li>
<li>
<p>month, months</p>
</li>
<li>
<p>week, weeks</p>
</li>
<li>
<p>day, days</p>
</li>
<li>
<p>hour, hours</p>
</li>
<li>
<p>minute, minutes</p>
</li>
<li>
<p>second, seconds</p>
</li>
<li>
<p>millisecond, milliseconds</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="operators">4.2. Operators</h3>
<div class="paragraph">
<p>Expressions can also contain <em>operators</em>, like those for mathematical operations and boolean logic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Appointment.minutesDuration / 60 &gt; 5
MedicationAdministration.wasNotGiven implies MedicationAdministration.reasonNotGiven.exists()
name.given | name.family // union of given and family names
'sir ' + name.given</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functions">4.3. Functions</h3>
<div class="paragraph">
<p>Finally, FluentPath supports the notion of functions, which all take a collection of values as input and produce another collection as output. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(name.given | name.family).count()
identifier.where(use = 'official')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since all functions work on collections, constants will first be converted to a collection when functions are invoked on constants:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(4+5).count()</code></pre>
</div>
</div>
<div class="paragraph">
<p>will return <code>1</code>, since this is implicitly a collection with one constant number <code>9</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="null-and-empty">4.4. Null and empty</h3>
<div class="paragraph">
<p>There is no concept of <code>null</code> in FluentPath. This means that when, in an underlying data object a member is null or missing, there will simply be no corresponding node for that member in the tree, e.g. <code>Patient.name</code> will return an empty collection (not null) if there are no name elements in the instance.</p>
</div>
<div class="paragraph">
<p>In expressions, the empty collection is represented as <code>{}</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="boolean-evaluation-of-collections">4.5. Boolean evaluation of collections</h3>
<div class="paragraph">
<p>Collections can be evaluated as booleans in logical tests in criteria. When a collection is implicitly converted to a boolean then:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IF the collection contains a single node AND the node&#8217;s value is a boolean THEN</p>
</li>
<li>
<p>the collection evaluates to the value of that single boolean node</p>
</li>
<li>
<p>ELSE IF the collection is empty THEN</p>
</li>
<li>
<p>the collection evaluates to an empty collection</p>
</li>
<li>
<p>ELSE</p>
</li>
<li>
<p>an error is raised</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This same principle applies when using the path statement in invariants.</p>
</div>
</div>
<div class="sect2">
<h3 id="propagation-of-empty-results">4.6. Propagation of empty results</h3>
<div class="paragraph">
<p>FluentPath functions and operators both propagate empty results, but the behavior is in general different when the argument to the function or operator expects a collection (e.g. <code>select()</code>, <code>where()</code> and <code>|</code> (union)) versus when the argument to the function or operator expects singleton value (e.g. <code>+</code> and <code>substring()</code>).</p>
</div>
<div class="paragraph">
<p>For functions or operators that expect singleton values, this means in general if the input is empty, then the result will be empty as well. More specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a singleton function operates on an empty collection, the result is an empty collection</p>
</li>
<li>
<p>If a singleton function is passed an empty collection as an argument, the result is an empty collection</p>
</li>
<li>
<p>If any operand to a singleton operator is an empty collection, the result is an empty collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For functions or arguments that expect collections, in general the empty collection is treated as any other collection would be. For example, the union (<code>|</code>) of an empty collection with a non-empty collection is the non-empty collection.</p>
</div>
<div class="paragraph">
<p>When functions or operators behave differently from these general principles, (for example the <code>count()</code> and <code>empty()</code> functions), this is clearly documented in the next sections.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functions-2">5. Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Functions are distinguished from path navigation names by the fact that they are followed by a <code>()</code> with zero or more parameters. With a few minor exceptions (e.g. the <code>today()</code> function), functions in FluentPath always take a collection as input and produce another collection as output, even though these may be collections of just a single item.</p>
</div>
<div class="paragraph">
<p>Correspondingly, arguments to the functions can be any FluentPath expression, though singleton functions require these expressions to evaluate to a collection containing a single item of a specific type. This approach allows functions to be chained, successively operating on the results of the previous function in order to produce the desired final result.</p>
</div>
<div class="paragraph">
<p>The following sections describe the functions supported in FluentPath, detailing the expected types of parameters and type of collection returned by the function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the function expects a parameter to be a single value (e.g. <code>item(index: integer)</code> and it is passed an argument that evaluates to a collection with multiple items or a collection with an item that is not of the required type, the evaluation of the expression will end and an error will be signaled to the calling environment.</p>
</li>
<li>
<p>If the function takes an <code>expression</code> as a parameter, the function will evaluate this parameter with respect to each of the items in the input collection. These expressions may refer to the special <code>$this</code> element, which represents the item from the input collection currently under evaluation. For example, in:
<code>name.given.where($this &gt; 'ba' and $this &lt; 'bc')</code> the <code>where()</code> function will iterate over each item in the input collection (elements named <code>given</code>) and <code>$this</code> will be set to each item when the expression passed to <code>where()</code> is evaluated.</p>
</li>
<li>
<p>Optional parameters are enclosed in square brackets in the definition of a function. Note that the brackets are only used to indicate optionality in the signature, they are not part of the actual syntax of FluentPath.</p>
</li>
<li>
<p>All functions return a collection, but if the function or operation will always produce a collection containing a single item of a predefined type, the description of the function will specify its output type explicitly, instead of just stating <code>collection</code>, e.g. <code>all(&#8230;&#8203;) : boolean</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="existence">5.1. Existence</h3>
<div class="sect3">
<h4 id="empty-boolean">5.1.1. empty() : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if the input collection is empty (<code>{ }</code>) and <code>false</code> otherwise.</p>
</div>
</div>
<div class="sect3">
<h4 id="not-boolean">5.1.2. not() : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if the input collection evaluates to <code>false</code>, and <code>false</code> if it evaluates to <code>true</code>. Otherwise, the result is empty (<code>{ }</code>):</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">&nbsp;</th>
<th class="tableblock halign-left valign-top">not</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="exists-criteria-expression-boolean">5.1.3. exists([criteria : expression]) : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if the collection has any elements, and <code>false</code> otherwise. This is the opposite of <code>empty()</code>, and as such is a shorthand for <code>empty().not()</code>. If the input collection is empty (<code>{ }</code>), the result is <code>false</code>.</p>
</div>
<div class="paragraph">
<p>The operator can also take an optional criteria to be applied to the collection prior to the determination of the exists. In this case, the operation is shorthand for <code>where(criteria).exists()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="all-criteria-expression-boolean">5.1.4. all(criteria : expression) : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if for every element in the input collection, <code>criteria</code> evaluates to <code>true</code>. Otherwise, the result is <code>false</code>. If the input collection is empty (<code>{ }</code>), the result is <code>true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="alltrue-boolean">5.1.5. allTrue() : boolean</h4>
<div class="paragraph">
<p>Takes a collection of boolean values and returns <code>true</code> if all the items are <code>true</code>. If any items are <code>false</code>, the result is <code>false</code>. If the input is empty (<code>{ }</code>), the result is <code>true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="anytrue-boolean">5.1.6. anyTrue() : boolean</h4>
<div class="paragraph">
<p>Takes a collection of boolean values and returns <code>true</code> if any of the items are <code>true</code>. If all the items are <code>false</code>, or if the input is empty (<code>{ }</code>), the result is <code>false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="subsetof-other-collection-boolean">5.1.7. subsetOf(other : collection) : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if all items in the input collection are members of the collection passed as the <code>other</code> argument. Membership is determined using the equals (<code>=</code>) operation (see below).</p>
</div>
<div class="paragraph">
<p>Conceptually, this function is evaluated by testing each element in the input collection for membership in the <code>other</code> collection, with a default of <code>true</code>. This means that if the input collection is empty (<code>{ }</code>), the result is <code>true</code>, otherwise if the <code>other</code> collection is empty (<code>{ }</code>), the result is <code>false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="supersetof-other-collection-boolean">5.1.8. supersetOf(other : collection) : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if all items in the collection passed as the <code>other</code> argument are members of the input collection. Membership is determined using the equals (<code>=</code>) operation (see below).</p>
</div>
<div class="paragraph">
<p>Conceptually, this function is evaluated by testing each element in the <code>other</code> collection for membership in the input collection, with a default of <code>false</code>. This means that if the input collection is empty (<code>{ }</code>), the result is <code>false</code>, otherwise if the <code>other</code> collection is empty (<code>{ }</code>), the result is <code>true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="isdistinct-boolean">5.1.9. isDistinct() : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if all the items in the input collection are distinct. To determine whether two items are distinct, the equals (<code>=</code>) operator is used, as defined below.</p>
</div>
<div class="paragraph">
<p>Conceptually, this function is shorthand for a comparison of the <code>count()</code> of the input collection against the <code>count()</code> of the <code>distinct()</code> of the input collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>X.count() = X.distinct().count()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that if the input collection is empty (<code>{ }</code>), the result is true.</p>
</div>
</div>
<div class="sect3">
<h4 id="distinct-collection">5.1.10. distinct() : collection</h4>
<div class="paragraph">
<p>Returns a collection containing only the unique items in the input collection. To determine whether two items are the same, the equals (<code>=</code>) operator is used, as defined below.</p>
</div>
<div class="paragraph">
<p>If the input collection is empty (<code>{ }</code>), the result is empty.</p>
</div>
</div>
<div class="sect3">
<h4 id="count-integer">5.1.11. count() : integer</h4>
<div class="paragraph">
<p>Returns a collection with a single value which is the integer count of the number of items in the input collection. Returns 0 when the input collection is empty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="filtering-and-projection">5.2. Filtering and projection</h3>
<div class="sect3">
<h4 id="where-criteria-expression-collection">5.2.1. where(criteria : expression) : collection</h4>
<div class="paragraph">
<p>Returns a collection containing only those elements in the input collection for which the stated <code>criteria</code> expression evaluates to <code>true</code>. Elements for which the expression evaluates to <code>false</code> or empty (<code>{ }</code>) are not included in the result.</p>
</div>
<div class="paragraph">
<p>If the input collection is emtpy (<code>{ }</code>), the result is empty.</p>
</div>
</div>
<div class="sect3">
<h4 id="select-projection-expression-collection">5.2.2. select(projection: expression) : collection</h4>
<div class="paragraph">
<p>Evaluates the <code>projection</code> expression for each item in the input collection. The result of each evaluation is added to the output collection. If the evaluation results in a collection with multiple items, all items are added to the output collection (collections resulting from evaluation of <code>projection</code> are <em>flattened</em>). This means that if the evaluation for an element results in the empty collection (<code>{ }</code>), no element is added to the result, and that if the input collection is empty (<code>{ }</code>), the result is empty as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="repeat-projection-expression-collection">5.2.3. repeat(projection: expression) : collection</h4>
<div class="paragraph">
<p>A version of <code>select</code> that will repeat the <code>projection</code> and add it to the output collection, as long as the projection yields new items (as determined by the equals (<code>=</code>) operator).</p>
</div>
<div class="paragraph">
<p>This operation can be used to traverse a tree and selecting only specific children:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ValueSet.expansion.repeat(contains)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will repeat finding children called <code>contains</code>, until no new nodes are found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Questionnaire.repeat(group | question).question</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will repeat finding children called <code>group</code> or <code>question</code>, until no new nodes are found.</p>
</div>
<div class="paragraph">
<p>Note that this is slightly different from</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Questionnaire.descendants().select(group | question)</code></pre>
</div>
</div>
<div class="paragraph">
<p>which would find <strong>any</strong> descendants called <code>group</code> or <code>question</code>, not just the ones nested inside other <code>group</code> or <code>question</code> elements.</p>
</div>
</div>
<div class="sect3">
<h4 id="oftype-type-identifier-collection">5.2.4. ofType(type : identifier) : collection</h4>
<div class="paragraph">
<p>Returns a collection that contains all items in the input collection that are of the given type or a subclass thereof. If the input collection is empty (<code>{ }</code>), the result is empty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="subsetting">5.3. Subsetting</h3>
<div class="sect3">
<h4 id="index-integer-collection">5.3.1. [ index : integer ] : collection</h4>
<div class="paragraph">
<p>The indexer operation returns a collection with only the <code>index</code>-th item (0-based index). If the input collection is empty (<code>{ }</code>), or the index lies outside the boundaries of the input collection, an empty collection is returned.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name[0]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="single-collection">5.3.2. single() : collection</h4>
<div class="paragraph">
<p>Will return the single item in the input if there is just one item. If the input collection is empty (<code>{ }</code>), the result is empty. If there are multiple items, an error is signaled to the evaluation environment. This operation is useful for ensuring that an error is returned if an assumption about cardinality is violated at run-time.</p>
</div>
</div>
<div class="sect3">
<h4 id="first-collection">5.3.3. first() : collection</h4>
<div class="paragraph">
<p>Returns a collection containing only the first item in the input collection. This function is equivalent to <code>item(0)</code>, so it will return an empty collection if the input collection has no items.</p>
</div>
</div>
<div class="sect3">
<h4 id="last-collection">5.3.4. last() : collection</h4>
<div class="paragraph">
<p>Returns a collection containing only the last item in the input collection. Will return an empty collection if the input collection has no items.</p>
</div>
</div>
<div class="sect3">
<h4 id="tail-collection">5.3.5. tail() : collection</h4>
<div class="paragraph">
<p>Returns a collection containing all but the first item in the input collection. Will return an empty collection if the input collection has no items, or only one item.</p>
</div>
</div>
<div class="sect3">
<h4 id="skip-num-integer-collection">5.3.6. skip(num : integer) : collection</h4>
<div class="paragraph">
<p>Returns a collection containing all but the first <code>num</code> items in the input collection. Will return an empty collection if there are no items remaining after the indicated number of items have been skipped, or if the input collection is empty. If <code>num</code> is less than or equal to zero, the input collection is simply returned.</p>
</div>
</div>
<div class="sect3">
<h4 id="take-num-integer-collection">5.3.7. take(num : integer) : collection</h4>
<div class="paragraph">
<p>Returns a collection containing the first <code>num</code> items in the input collection, or less if there are less than <code>num</code> items. If num is less than or equal to 0, or if the input collection is empty (<code>{ }</code>), <code>take</code> returns an empty collection.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conversion">5.4. Conversion</h3>
<div class="paragraph">
<p>The functions in this section operate on collections with a single item. If there is more than one item, or an incompatible item, the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>To use these functions over a collection with multiple items, one may use filters like <code>where()</code> and <code>select()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given.select(substring(1))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example returns a collection containing the first character of all the given names for a patient.</p>
</div>
<div class="sect3">
<h4 id="iif-criterium-boolean-true-expression-collection-otherwise-expression-collection-collection">5.4.1. iif(criterium: boolean, true-expression: collection [, otherwise-expression: collection]) : collection</h4>
<div class="paragraph">
<p>If <code>criterium</code> is true, the function evaluates the <code>true-expression</code> on the input and returns that as a result.</p>
</div>
<div class="paragraph">
<p>If <code>criterium</code> is <code>false</code> or an empty collection, the <code>otherwise-expression</code> is evaluated on the input and returned, unless the optional <code>otherwise-expression</code> is not given, in which case the function returns an empty collection.</p>
</div>
</div>
<div class="sect3">
<h4 id="tointeger-integer">5.4.2. toInteger() : integer</h4>
<div class="paragraph">
<p>If the input collection contains a single item, this function will return a single integer if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the item in the input collection is an integer</p>
</li>
<li>
<p>the item in the input collection is a string and is convertible to an integer</p>
</li>
<li>
<p>the item is a boolean, where <code>true</code> results in a 1 and <code>false</code> results in a 0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the item is not one the above types, the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>If the item is a string, but the string is not convertible to an integer (using the regex format <code>(+|-)?#0</code>), the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>In all other cases, the function will return an empty collection.</p>
</div>
</div>
<div class="sect3">
<h4 id="todecimal-decimal">5.4.3. toDecimal() : decimal</h4>
<div class="paragraph">
<p>If the input collection contains a single item, this function will return a single decimal if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the item in the input collection is an integer or decimal</p>
</li>
<li>
<p>the item in the input collection is a string and is convertible to a decimal</p>
</li>
<li>
<p>the item is a boolean, where <code>true</code> results in a <code>1.0</code> and <code>false</code> results in a <code>0.0</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the item is not one of the above types, the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>If the item is a string, but the string is not convertible to a decimal (using the regex format <code>(+|-)?<mark>0(.0</mark>)?</code>), the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>In all other cases, the function will return an empty collection.</p>
</div>
</div>
<div class="sect3">
<h4 id="tostring-string">5.4.4. toString() : string</h4>
<div class="paragraph">
<p>If the input collection contains a single item, this function will return a single string if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the item in the input collection is a string</p>
</li>
<li>
<p>the item in the input collection is an integer, decimal, time or dateTime the output will contain its string representation</p>
</li>
<li>
<p>the item is a boolean, where <code>true</code> results in <code>&#39;true&#39;</code> and <code>false</code> in <code>&#39;false&#39;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the item is not one of the above types, the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>The string representation uses the following formats:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Representation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code> or <code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(-)?#0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>decimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(-)?<mark>0.0</mark></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>quantity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(-)?<mark>0.0</mark> &#39;&lt;unit&gt;&#39;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dateTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>YYYY-MM-DDThh:mm:ss.fff(+/-)hh:mm</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Thh:mm:ss.fff(+/-)hh:mm</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that for partial dates and times, the result will only be specified to the level of precision in the value being converted.</p>
</div>
<div class="paragraph">
<p>In all other cases, the function will return an empty collection.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="string-manipulation">5.5. String Manipulation</h3>
<div class="paragraph">
<p>The functions in this section operate on collections with a single item. If there is more than one item, or an item that is not a string, the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="sect3">
<h4 id="indexof-substring-string-integer">5.5.1. indexOf(substring : string) : integer</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, will return the 0-based index of the first position this substring is found in the input string, or -1 if it is not found. If the <code>substring</code> is an empty string, the function returns 0.</p>
</div>
</div>
<div class="sect3">
<h4 id="substring-start-integer-length-integer-string">5.5.2. substring(start : integer [, length : integer]) : string</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, it returns a collection with the part of the string starting at position <code>start</code> (zero-based). If <code>length</code> is given, will return at most <code>length</code> number of characters from the input string.</p>
</div>
<div class="paragraph">
<p>If <code>start</code> lies outside the length of the string, the function returns an empty collection. If there are less remaining characters in the string than indicated by <code>length</code>, the function returns just the remaining characters.</p>
</div>
</div>
<div class="sect3">
<h4 id="startswith-prefix-string-boolean">5.5.3. startsWith(prefix : string) : boolean</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, the function will return <code>true</code> when the input string starts with the given <code>prefix</code>. Also returns <code>true</code> when <code>prefix</code> is the empty string.</p>
</div>
</div>
<div class="sect3">
<h4 id="endswith-suffix-string-boolean">5.5.4. endsWith(suffix : string) : boolean</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, the function will return <code>true</code> when the input string ends with the given <code>suffix</code>. Also returns <code>true</code> when <code>suffix</code> is the empty string.</p>
</div>
</div>
<div class="sect3">
<h4 id="contains-substring-string-boolean">5.5.5. contains(substring : string) : boolean</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, the function will return <code>true</code> when the given <code>substring</code> is a substring of the input string. Also returns <code>true</code> when <code>substring</code> is the empty string.</p>
</div>
</div>
<div class="sect3">
<h4 id="replace-pattern-string-substitution-string-string">5.5.6. replace(pattern : string, substitution : string) : string</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, the function will return the input string with all instances of <code>pattern</code> replaced with <code>substitution</code>. If the substitution is the empty string, the instances of the pattern are removed from the input string. If the pattern is the empty string, every character in the input string is surrounded by the substitution, e.g. <code>&#39;abc&#39;.replace(&#39;&#39;,&#39;x&#39;)</code> becomes <code>&#39;xaxbxcx&#39;</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="matches-regex-string-boolean">5.5.7. matches(regex : string) : boolean</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, the function will return <code>true</code> when the value matches the given regular expression. Regular expressions should function consistently, regardless of any culture- and locale-specific settings in the environment, should be case-sensitive, use 'single line' mode and allow Unicode characters.</p>
</div>
</div>
<div class="sect3">
<h4 id="replacematches-regex-string-substitution-string-string">5.5.8. replaceMatches(regex : string, substitution: string) : string</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, the function will match the input using the regular expression in <code>regex</code> and replace each match with the <code>substitution</code> string. The substitution may refer to identified match groups in the regular expression.</p>
</div>
<div class="paragraph">
<p>This example of <code>replace()</code> will convert a string with a date formatted as MM/dd/yy to dd-MM-yy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>'11/30/1972'.replace('\\b(?&lt;month&gt;\\d{1,2})/(?&lt;day&gt;\\d{1,2})/(?&lt;year&gt;\\d{2,4})\\b',
       '${day}-${month}-${year}')</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: Platforms will typically use native regular expression implementations. These are typically fairly similar, but there will always be small differences. As such, FluentPath does not prescribe a particular dialect, but recommends the use of the dialect defined by as part of <a href="https://www.w3.org/TR/xmlschema11-2/#regexs">XML Schema 1.1</a> as the dialect most likely to be broadly supported and understood.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="length-integer">5.5.9. length() : integer</h4>
<div class="paragraph">
<p>If the input collection contains a single item of type string, the function will return the length of the string. If the input collection is empty (<code>{ }</code>), the result is empty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tree-navigation">5.6. Tree navigation</h3>
<div class="sect3">
<h4 id="children-collection">5.6.1. children() : collection</h4>
<div class="paragraph">
<p>Returns a collection with all immediate child nodes of all items in the input collection.</p>
</div>
</div>
<div class="sect3">
<h4 id="descendants-collection">5.6.2. descendants() : collection</h4>
<div class="paragraph">
<p>Returns a collection with all descendant nodes of all items in the input collection. The result does not include the nodes in the input collection themselves. Is a shorthand for <code>repeat(children())</code>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: Many of these functions will result in a set of nodes of different underlying types. It may be necessary to use <code>ofType()</code> as described in the previous section to maintain type safety. See section 8 for more information about type safe use of FluentPath expressions.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect2">
<h3 id="utility-functions">5.7. Utility functions</h3>
<div class="sect3">
<h4 id="trace-name-string-collection">5.7.1. trace(name : string) : collection</h4>
<div class="paragraph">
<p>Add a string representation of the input collection to the diagnostic log, using the parameter <code>name</code> as the name in the log. This log should be made available to the user in some appropriate fashion. Does not change the input, so returns the input collection as output.</p>
</div>
</div>
<div class="sect3">
<h4 id="today-datetime">5.7.2. today() : datetime</h4>
<div class="paragraph">
<p>Returns a datetime containing the current date.</p>
</div>
</div>
<div class="sect3">
<h4 id="now-datetime">5.7.3. now() : datetime</h4>
<div class="paragraph">
<p>Returns a datetime containing the current date and time, including timezone.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="operations">6. Operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Operators are allowed to be used between any kind of path expressions (e.g. expr op expr). Like functions, operators will generally propagate an empty collection in any of their operands. This is true even when comparing two empty collections using the equality operators, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{} = {}
true &gt; {}
{} != 'dummy'</code></pre>
</div>
</div>
<div class="paragraph">
<p>all result in <code>{}</code>.</p>
</div>
<div class="sect2">
<h3 id="equality">6.1. Equality</h3>
<div class="sect3">
<h4 id="equals">6.1.1. = (Equals)</h4>
<div class="paragraph">
<p>Returns <code>true</code> if the left collection is equal to the right collection:</p>
</div>
<div class="paragraph">
<p>If both operands are collections with a single item:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For primitives:</p>
<div class="ulist">
<ul>
<li>
<p><code>string</code>: comparison is based on Unicode values</p>
</li>
<li>
<p><code>integer</code>: values must be exactly equal</p>
</li>
<li>
<p><code>decimal</code>: values must be equal, trailing zeroes are ignored</p>
</li>
<li>
<p><code>boolean</code>: values must be the same</p>
</li>
<li>
<p><code>dateTime</code>: must be exactly the same, respecting the timezone (though +24:00 = +00:00 = Z)</p>
</li>
<li>
<p><code>time</code>: must be exactly the same, respecting the timezone (though +24:00 = +00:00 = Z)</p>
</li>
<li>
<p>If a <code>time</code> or <code>dateTime</code> has no indication of timezone, the timezone of the evaluating machine is assumed.</p>
</li>
</ul>
</div>
</li>
<li>
<p>For complex types, equality requires all child properties to be equal, recursively.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If both operands are collections with multiple items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each item must be equal</p>
</li>
<li>
<p>Comparison is order dependent</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otherwise, equals returns <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Note that this implies that if the collections have a different number of items to compare, the result will be <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Typically, this operator is used with single fixed values as operands. This means that <code>Patient.telecom.system = &#39;phone&#39;</code> will return <code>false</code> if there is more than one <code>telecom</code> with a <code>use</code>. Typically, you&#8217;d want Patient.telecom.where(system = 'phone')</p>
</div>
<div class="paragraph">
<p>If one or both of the operands is the empty collection, this operation returns an empty collection.</p>
</div>
<div class="paragraph">
<p>For <code>dateTime</code> and <code>time</code> comparisons with partial values (e.g. dateTimes specified only to the day, or times specified only to the hour), the comparison returns empty (<code>{ }</code>), not <code>false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="equivalent">6.1.2. ~ (Equivalent)</h4>
<div class="paragraph">
<p>Returns <code>true</code> if the collections are the same. In particular, comparing empty collections for equivalence <code>{ } ~ { }</code> will result in <code>true</code>.</p>
</div>
<div class="paragraph">
<p>If both operands are collections with a single item:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For primitives</p>
</li>
<li>
<p><code>string</code>: the strings must be the same while ignoring case and normalizing whitespace.</p>
</li>
<li>
<p><code>integer</code>: exactly equal</p>
</li>
<li>
<p><code>decimal</code>: values must be equal, comparison is done on values rounded to the precision of the least precise operand. Trailing zeroes are ignored in determining precision.</p>
</li>
<li>
<p><code>dateTime</code> and <code>time</code>: values must be equal, except that for partial date/time values, the comparison returns <code>false</code>, not empty (<code>{ }</code>). If one operand has less precision than the other, comparison is done at the lowest precision.</p>
</li>
<li>
<p><code>boolean</code>: the values must be the same</p>
</li>
<li>
<p>For complex types, equivalence requires all child properties to be equivalent, recursively.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If both operands are collections with multiple items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each item must be equivalent</p>
</li>
<li>
<p>Comparison is not order dependent</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that this implies that if the collections have a different number of items to compare, the result will be <code>false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="not-equals">6.1.3. != (Not Equals)</h4>
<div class="paragraph">
<p>The inverse of the equals operator.</p>
</div>
</div>
<div class="sect3">
<h4 id="not-equivalent">6.1.4. !~ (Not Equivalent)</h4>
<div class="paragraph">
<p>The inverse of the equivalent operator.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comparison">6.2. Comparison</h3>
<div class="ulist">
<ul>
<li>
<p>The comparison operators are defined for strings, integers, decimals, datetimes and times.</p>
</li>
<li>
<p>If one or both of the arguments is an empty collection, a comparison operator will return an empty collection.</p>
</li>
<li>
<p>Unless there is only one item in each collection (left and right), the comparisons return false</p>
</li>
<li>
<p>Both arguments must be of the same type, and the evaluator will throw an error if the types differ.</p>
</li>
<li>
<p>When comparing integers and decimals, the integer will be converted to a decimal to make comparison possible.</p>
</li>
<li>
<p>String ordering is strictly lexical and is based on the Unicode value of the individual characters.
*</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For partial date/time values, the comparison is performed to the highest precision specified in both values.</p>
</div>
<div class="sect3">
<h4 id="greater-than">6.2.1. &gt; (Greater Than)</h4>

</div>
<div class="sect3">
<h4 id="less-than">6.2.2. &lt; (Less Than)</h4>

</div>
<div class="sect3">
<h4 id="less-or-equal">6.2.3. &lt;= (Less or Equal)</h4>

</div>
<div class="sect3">
<h4 id="greater-or-equal">6.2.4. &gt;= (Greater or Equal)</h4>

</div>
</div>
<div class="sect2">
<h3 id="types">6.3. Types</h3>
<div class="sect3">
<h4 id="is">6.3.1. is</h4>
<div class="paragraph">
<p>If the left operand is a collection with a single item and the second operand is an identifier, this operator returns <code>true</code> if the type of the left operand is the type specified in the second operand, or a subclass thereof. In all other cases this function returns the empty collection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.contained.all($this is Patient implies age &gt; 10)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="as">6.3.2. as</h4>
<div class="paragraph">
<p>If the left operand is a collection with a single item and the second operand is an identifier, this function returns the value of the left operand, or a subclass thereof. Otherwise, this operator returns the empty collection.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="collections-2">6.4. Collections</h3>
<div class="sect3">
<h4 id="union-collections">6.4.1. | (union collections)</h4>
<div class="paragraph">
<p>Merge the two collections into a single collection, eliminating any duplicate values (using equals (<code>=</code>)) to determine equality).</p>
</div>
</div>
<div class="sect3">
<h4 id="in-membership">6.4.2. in (membership)</h4>
<div class="paragraph">
<p>If the left operand is a collection with a single item, this operator returns true if the item is in the right operand using equality semantics. This is the inverse operation of contains.</p>
</div>
</div>
<div class="sect3">
<h4 id="contains-containership">6.4.3. contains (containership)</h4>
<div class="paragraph">
<p>If the right operand is a collection with a single item, this operator returns true if the item is in the left operand using equality semantics. This is the inverse operation of in.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="boolean-logic">6.5. Boolean logic</h3>
<div class="paragraph">
<p>For all boolean operators, the collections passed as operands are first evaluated as booleans (as described in Boolean Evaluation of Collections). The operators then use three-valued logic to propagate empty operands.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: To ensure that FluentPath expressions can be freely rewritten by underlying implementations, there is no expectation that an implementation respect short-circuit evaluation. With regard to performance, implementations may use short-circuit evaluation to reduce computation, but authors should not rely on such behavior, and implementations must not change semantics with short-circuit evaluation. If a condition is needed to ensure correct evaluation of a subsequent expression, the <code>iif()</code> function should be used to guarantee that the condition determines whether evaluation of an expression will occur at run-time.</p>
</div>
</blockquote>
</div>
<div class="sect3">
<h4 id="and">6.5.1. and</h4>
<div class="paragraph">
<p>Returns <code>true</code> if both operands evaluate to <code>true</code>, <code>false</code> if either operand evaluates to <code>false</code>, and empty collection (<code>{ }</code>) otherwise:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">&nbsp;</th>
<th class="tableblock halign-left valign-top"><code>true</code></th>
<th class="tableblock halign-left valign-top"><code>false</code></th>
<th class="tableblock halign-left valign-top">empty (<code>{ }</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="or">6.5.2. or</h4>
<div class="paragraph">
<p>Returns <code>false</code> if both operands evaluate to <code>false</code>, <code>true</code> if either operand evaluates to <code>true</code>, and empty (<code>{ }</code>) otherwise:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">&nbsp;</th>
<th class="tableblock halign-left valign-top"><code>true</code></th>
<th class="tableblock halign-left valign-top"><code>false</code></th>
<th class="tableblock halign-left valign-top">empty (<code>{ }</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="xor">6.5.3. xor</h4>
<div class="paragraph">
<p>Returns <code>true</code> if exactly one of the operands evaluates to <code>true</code>, <code>false</code> if either both operands evaluate to <code>true</code> or both operands evaluate to <code>false</code>, and the empty collection (<code>{ }</code>) otherwise:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">&nbsp;</th>
<th class="tableblock halign-left valign-top"><code>true</code></th>
<th class="tableblock halign-left valign-top"><code>false</code></th>
<th class="tableblock halign-left valign-top">empty (<code>{ }</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="implies">6.5.4. implies</h4>
<div class="paragraph">
<p>If the left operand evaluates to <code>true</code>, this operator returns the boolean evaluation of the right operand. If the left operand evaluates to <code>false</code>, this operator returns <code>true</code>. Otherwise, this operator returns <code>true</code> if the right operand evaluates to <code>true</code>, and the empty collection (<code>{ }</code>) otherwise.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">&nbsp;</th>
<th class="tableblock halign-left valign-top"><code>true</code></th>
<th class="tableblock halign-left valign-top"><code>false</code></th>
<th class="tableblock halign-left valign-top">empty (<code>{ }</code>)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty (<code>{ }</code>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The implies operator is useful for testing conditionals. For example, if a given name is present, then a family name must be as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given.exists() implies Patient.name.family.exists()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="math">6.6. Math</h3>
<div class="paragraph">
<p>The math operators require each operand to be a single element. Both operands must be of the same type, each operator below specifies which types are supported.</p>
</div>
<div class="paragraph">
<p>If there is more than one item, or an incompatible item, the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>As with the other operators, the math operators will return an empty collection if one or both of the operands are empty.</p>
</div>
<div class="sect3">
<h4 id="multiplication">6.6.1. * (multiplication)</h4>
<div class="paragraph">
<p>Multiplies both arguments (numbers only)</p>
</div>
</div>
<div class="sect3">
<h4 id="division">6.6.2. / (division)</h4>
<div class="paragraph">
<p>Divides the left operand by the right operand (numbers only).</p>
</div>
</div>
<div class="sect3">
<h4 id="addition">6.6.3. + (addition)</h4>
<div class="paragraph">
<p>For integer and decimal, add the operands. For strings, concatenates the right operand to the left operand.</p>
</div>
</div>
<div class="sect3">
<h4 id="subtraction">6.6.4. - (subtraction)</h4>
<div class="paragraph">
<p>Subtracts the right operand from the left operand (numbers only).</p>
</div>
</div>
<div class="sect3">
<h4 id="div">6.6.5. div</h4>
<div class="paragraph">
<p>Performs truncated division of the left operand by the right operand (numbers only).</p>
</div>
</div>
<div class="sect3">
<h4 id="mod">6.6.6. mod</h4>
<div class="paragraph">
<p>Computes the remainder of the truncated division of its arguments (numbers only).</p>
</div>
</div>
<div class="sect3">
<h4 id="string-concatenation">6.6.7. &amp; (string concatenation)</h4>
<div class="paragraph">
<p>For strings, will concatenate the strings, where an empty operand is taken to be the empty string. This differs from <code>+</code> on two strings, which will result in an empty collection when one of the operands is empty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="date-time-arithmetic">6.7. Date/Time Arithmetic</h3>
<div class="paragraph">
<p>Date and time arithmetic operators are used to add time-valued quantities to date/time values. The left operand must be a <code>dateTime</code> or <code>time</code> value, and the right operand must be a <code>quantity</code> with a time-valued unit:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>year</code>, <code>year</code>, or <code>&#39;a&#39;</code></p>
</li>
<li>
<p><code>month</code>, <code>months</code>, or <code>&#39;mo&#39;</code></p>
</li>
<li>
<p><code>week</code>, <code>weeks</code> or <code>&#39;wk&#39;</code></p>
</li>
<li>
<p><code>day</code>, <code>days</code>, or <code>&#39;d&#39;</code></p>
</li>
<li>
<p><code>hour</code>, <code>hours</code>, or <code>&#39;h&#39;</code></p>
</li>
<li>
<p><code>minute</code>, <code>minutes</code>, or <code>&#39;min&#39;</code></p>
</li>
<li>
<p><code>second</code>, <code>seconds</code>, or <code>&#39;s&#39;</code></p>
</li>
<li>
<p><code>millisecond</code>, <code>milliseconds</code>, or <code>&#39;ms&#39;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If there is more than one item, or an item of an incompatible type, the evaluation of the expression will end and signal an error to the calling environment.</p>
</div>
<div class="paragraph">
<p>If either or both arguments are empty (<code>{ }</code>), the result is empty (<code>{ }</code>).</p>
</div>
<div class="sect3">
<h4 id="addition-2">6.7.1. + (addition)</h4>
<div class="paragraph">
<p>Returns the value of the given <code>dateTime</code> or <code>time</code>, incremented by the time-valued quantity, respecting variable length periods for calendar years and months.</p>
</div>
<div class="paragraph">
<p>For <code>dateTime</code> values, the quantity unit must be one of: <code>years</code>, <code>months</code>, <code>days</code>, <code>hours</code>, <code>minutes</code>, <code>seconds</code>, or <code>milliseconds</code> (or an equivalent unit), or an error is raised.</p>
</div>
<div class="paragraph">
<p>For <code>time</code> values, the quantity unit must be one of: <code>hours</code>, <code>minutes</code>, <code>seconds</code>, or <code>milliseconds</code> (or an equivalent unit), or an error is raised.</p>
</div>
<div class="paragraph">
<p>For partial date/time values, the operation is performed by converting the time-valued quantity to the highest precision in the partial (removing any decimal value off) and then adding to the date/time value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@2014 + 24 months</code></pre>
</div>
</div>
<div class="paragraph">
<p>This expression will evaluate to the value <code>@2016</code> even though the date/time value is not specified to the level of precision of the time-valued quantity.</p>
</div>
</div>
<div class="sect3">
<h4 id="subtraction-2">6.7.2. - (subtraction)</h4>
<div class="paragraph">
<p>Returns the value of the given <code>dateTime</code> or <code>time</code>, decremented by the time-valued quantity, respecting variable length periods for calendar years and months.</p>
</div>
<div class="paragraph">
<p>For <code>dateTime</code> values, the quantity unit must be one of: <code>years</code>, <code>months</code>, <code>days</code>, <code>hours</code>, <code>minutes</code>, <code>seconds</code>, <code>milliseconds</code> (or an equivalent unit), or an error is raised.</p>
</div>
<div class="paragraph">
<p>For <code>time</code> values, the quantity unit must be one of: <code>hours</code>, <code>minutes</code>, <code>seconds</code>, or <code>milliseconds</code> (or an equivalent unit), or an error is raised.</p>
</div>
<div class="paragraph">
<p>For partial date/time values, the operation is performed by converting the time-valued quantity to the highest precision in the partial (removing any decimal value off) and then subtracting from the date/time value. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@2014 - 24 months</code></pre>
</div>
</div>
<div class="paragraph">
<p>This expression will evaluate to the value <code>@2012</code> even though the date/time value is not specified to the level of precision of the time-valued quantity.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="operator-precedence">6.8. Operator precedence</h3>
<div class="paragraph">
<p>Precedence of operations, in order from high to low:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>#01 . (path/function invocation)
#02 [] (indexer)
#03 unary + and -
#04: *, /, div, mod
#05: +, -, &amp;
#06: |
#07: &gt;, &lt;, &gt;=, &lt;=
#08: is, as
#09: =, ~, !=, !~
#10: in, contains
#11: and
#12: xor, or
#13: implies</code></pre>
</div>
</div>
<div class="paragraph">
<p>As customary, expressions may be grouped by parenthesis (<code>()</code>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="environment-variables">7. Environment variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A token introduced by a % refers to a value that is passed into the evaluation engine by the calling environment. Using environment variables, authors can avoid repetition of fixed values and can pass in external values and data.</p>
</div>
<div class="paragraph">
<p>The following environmental values are set for all contexts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>%ucum       - (string) url for ucum
%context	- The original node that was passed to the evaluation engine before starting evaluation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementers should note that using additional environment variables is a formal extension point for the language. Various usages of FluentPath may define their own externals, and implementers should provide some appropriate configuration framework to allow these constants to be provided to the evaluation engine at run time. E.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>%us-zip = '[0-9]{5}(-[0-9]{4}){0,1}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that these tokens are not restricted to simple types, and they may have values that are not defined fixed values known prior to evaluation at run-time, though there is no way to define these kind of values in implementation guides.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reflection">8. Reflection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FluentPath supports reflection to provide the ability for expressions to access type information describing the structure of values. The <code>type()</code> function returns the type information for each element of the input collection.</p>
</div>
<div class="paragraph">
<p>For primitive types, the result is a <code>SimpleTypeInfo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>SimpleTypeInfo { name: String, baseType: TypeInfo }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For class types, the result is a <code>ClassInfo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ClassInfoElement { name: String, type: TypeInfo }
ClassInfo { name: String, baseType: TypeInfo, element: List&lt;ClassInfoElement&gt; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For collection types, the result is a <code>ListTypeInfo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ListTypeInfo { elementType: TypeInfo }</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for anonymous types, the result is a <code>TupleTypeInfo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>TupleTypeInfoElement { name: String, type: TypeInfo }
TupleTypeInfo { element: List&lt;TupleTypeInfoElement&gt; }</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: These structures are a subset of the abstract metamodel used by the Clinical Quality Language Tooling defined here: <a href="https://github.com/cqframework/clinical_quality_language/blob/dstu-updates/Src/cql-lm/schema/elm/modelinfo.xsd">modelinfo.xsd</a>.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="type-safety-and-strict-evaluation">9. Type safety and strict evaluation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Strongly typed languages are intended to help authors avoid mistakes by ensuring that the expressions describe meaningful operations. For example, a strongly typed language would typically disallow the expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>1 + 'John'</code></pre>
</div>
</div>
<div class="paragraph">
<p>because it performs an invalid operation, namely adding numbers and strings. However, there are cases where the author knows that a particular invocation may be safe, but the compiler is not aware of, or cannot infer, the reason. In these cases, type-safety errors can become an unwelcome burden, especially for experienced developers.</p>
</div>
<div class="paragraph">
<p>As a result, FluentPath defines a <em>strict</em> option that allows an execution environment to determine how much type safety should be applied. With <em>strict</em> enabled, FluentPath behaves as a traditional strongly-typed language, whereas without <em>strict</em>, it behaves as a traditional dynamically-typed language.</p>
</div>
<div class="paragraph">
<p>For example, since some functions and most operators will only accept a single item as input, and throw an exception otherwise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given + ' ' + Patient.name.family</code></pre>
</div>
</div>
<div class="paragraph">
<p>will work perfectly fine, as long as the patient has a single name, but will fail otherwise. It is in fact "safer" to formulate such statements as either:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.select(given + ' ' + family)</code></pre>
</div>
</div>
<div class="paragraph">
<p>which would return a collection of concatenated first and last names, one for each name of a patient. Of course, if the patient turns out to have multiple given names, even this statement will fail and the author would need to choose the first name in each collection explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.first().select(given.first() + ' ' + family.first())</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is clear that, although more robust, the last expression is also much more elaborate, certainly in situations where, because of external constraints, the author is sure names will not repeat, even if the unconstrained data model allows repetition.</p>
</div>
<div class="paragraph">
<p>Apart from throwing exceptions, unexpected outcomes may result because of the way the equality operators are defined. The expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given = 'Wouter'</code></pre>
</div>
</div>
<div class="paragraph">
<p>will return false as soon as a patient has multiple names, even though one of those may well be 'Wouter'. Again, this can be corrected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.where(given = 'Wouter').exists()</code></pre>
</div>
</div>
<div class="paragraph">
<p>but is still less concise than would be possible if constraints were well known in advance.</p>
</div>
<div class="paragraph">
<p>The strict option provides a mode in which the author of the FluentPath statement is protected against such cases by employing strict typing. Based on the definition of the operators and functions and given the type of input, a compiler can trace the statement and determine whether "unsafe" situations can occur.</p>
</div>
<div class="paragraph">
<p>Unsafe uses are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A function that requires an input collection with a single item is called on an output that is not guaranteed to have only one item.</p>
</li>
<li>
<p>A function is passed an argument that is not guaranteed to be a single value.</p>
</li>
<li>
<p>A function is passed an input value or argument that is not of the expected type</p>
</li>
<li>
<p>An operator that requires operands to be collections with a single item is called with arguments that are not guaranteed to have only one item.</p>
</li>
<li>
<p>An operator has operands that are not of the expected type</p>
</li>
<li>
<p>Equality operators are used on operands that are not both collections or collections of single items.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are a few constructs in the FluentPath language where the compiler cannot trace the type, and should issue a warning to the user when doing "strict" evaluation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>children()</code> and <code>descendants()</code> functions</p>
</li>
<li>
<p>The <code>resolve()</code> function</p>
</li>
<li>
<p>A member which is polymorphic (e.g. a choice[x] type in FHIR)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authors can use the <code>as()</code> function directly after such constructs to inform the compiler of the expected type, so that strict type-checking can continue.</p>
</div>
<div class="paragraph">
<p>In strict mode, when the compiler finds places where a collection of multiple items can be present while just a single item is expected, the author will need to make explicit how repetitions are dealt with. Depending on the situation one may:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>first()</code>, <code>last()</code> or indexer (<code>[ ]</code>) to select a single item</p>
</li>
<li>
<p>Use <code>select()</code> and <code>where()</code> to turn the expression into one that evaluates each of the repeating items individually (as in the examples above)</p>
</li>
<li>
<p>Use <code>single()</code> to return either the single item or else an empty collection. This is especially useful when using FluentPath to formulate invariants: in cases where single items are considered the "positive" or "true" situation, <code>single()</code> will return an empty collection, so the invariant will evaluate to the empty collection (or false) in any other circumstance.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>[27-1-2016 20:53:40] Grahame Grieve: I still disagree with the way that the strict evaluation
section is framed. The issue should be described, and then possible approaches defined,
including type level evaluation for warnings. I'm not sure when a strict mode on evaluation would actually be appropriate or
whether strict must be applied purely based on the type definitions, or whether an evaluation
engine is allowed to be aware of contextual constraints in addition to the type definitions</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>as() will not be useable if the parent, children or descendants contain backbone elements (which they will). This might not be a big problem, e.g.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Questionnaire.descendants().question</pre>
</div>
</div>
<div class="paragraph">
<p>will really always just select the "anonymous" child called "question" and thus the Question complex element, but we will not get any typesafety again until we do</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Questionnaire.descendants().question.concept.as('Coding').etc</pre>
</div>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="formal-syntax">Appendix A: Formal Syntax</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>grammar fluentpath;

expression
        : term                                                      #termExpression
        | expression '.' invocation                                 #invocationExpression
        | expression '[' expression ']'                             #indexerExpression
        | ('+' | '-') expression                                    #polarityExpression
        | expression ('*' | '/' | 'div' | 'mod') expression         #multiplicativeExpression
        | expression ('+' | '-' | '&amp;') expression                   #additiveExpression
        | expression '|' expression                                 #unionExpression
        | expression ('&lt;=' | '&lt;' | '&gt;' | '&gt;=') expression           #inequalityExpression
        | expression ('is' | 'as') typeSpecifier                    #typeExpression
        | expression ('=' | '~' | '!=' | '!~' | '&lt;&gt;') expression    #equalityExpression
        | expression ('in' | 'contains') expression                 #membershipExpression
        | expression 'and' expression                               #andExpression
        | expression ('or' | 'xor') expression                      #orExpression
        | expression 'implies' expression                           #impliesExpression
        ;

term
        : invocation                                            #invocationTerm
        | literal                                               #literalTerm
        | externalConstant                                      #externalConstantTerm
        | '(' expression ')'                                    #parenthesizedTerm
        ;

literal
        : '{' '}'                                               #nullLiteral
        | ('true' | 'false')                                    #booleanLiteral
        | STRING                                                #stringLiteral
        | NUMBER                                                #numberLiteral
        | DATETIME                                              #dateTimeLiteral
        | TIME                                                  #timeLiteral
        | quantity                                              #quantityLiteral
        ;

externalConstant
        : '%' identifier
        ;

invocation                          // Terms that can be used after the function/member invocation '.'
        : identifier                                            #memberInvocation
        | function                                              #functionInvocation
        | '$this'                                               #thisInvocation
        ;

function
        : identifier '(' paramList? ')'
        ;

paramList
        : expression (',' expression)*
        ;

quantity
        : NUMBER unit?
        ;

unit
        : dateTimePrecision
        | pluralDateTimePrecision
        | STRING // UCUM syntax for units of measure
        ;

dateTimePrecision
        : 'year' | 'month' | 'week' | 'day' | 'hour' | 'minute' | 'second' | 'millisecond'
        ;

pluralDateTimePrecision
        : 'years' | 'months' | 'weeks' | 'days' | 'hours' | 'minutes' | 'seconds' | 'milliseconds'
        ;

typeSpecifier
        : qualifiedIdentifier
        ;

qualifiedIdentifier
        : identifier ('.' identifier)*
        ;

identifier
        : IDENTIFIER
        | QUOTEDIDENTIFIER
        | 'as'
        | 'is'
        ;

DATETIME
        : '@'
            [0-9][0-9][0-9][0-9] // year
            (
                '-'[0-9][0-9] // month
                (
                    '-'[0-9][0-9] // day
                    (
                        'T'
                            [0-9][0-9] (':'[0-9][0-9] (':'[0-9][0-9] ('.'[0-9]+)?)?)?
                            ('Z' | ('+' | '-') [0-9][0-9]':'[0-9][0-9])? // timezone
                    )?
                 )?
             )?
             'Z'? // UTC specifier
        ;

TIME
        : '@'
            'T'
                [0-9][0-9] (':'[0-9][0-9] (':'[0-9][0-9] ('.'[0-9]+)?)?)?
                ('Z' | ('+' | '-') [0-9][0-9]':'[0-9][0-9])? // timezone
        ;

IDENTIFIER
        : ([A-Za-z] | '_')([A-Za-z0-9] | '_')*  // Added _ to support CQL (FHIR could constrain it out)
        ;

QUOTEDIDENTIFIER
        : '"' (ESC | ~[\\"])* '"'
        ;

STRING
        : '\'' (ESC | ~[\'])* '\''
        ;

// Also allows leading zeroes now (just like CQL and XSD)
NUMBER
        : [0-9]+('.' [0-9]+)?
        ;

// Pipe whitespace to the HIDDEN channel to support retrieving source text through the parser.
WS
        : [ \r\n\t]+ -&gt; channel(HIDDEN)
        ;

COMMENT
        : '/*' .*? '*/' -&gt; channel(HIDDEN)
        ;

LINE_COMMENT
        : '//' ~[\r\n]* -&gt; channel(HIDDEN)
        ;

fragment ESC
        : '\\' (["'\\/fnrt] | UNICODE)    // allow \", \', \\, \/, \f, etc. and \uXXX
        ;

fragment UNICODE
        : 'u' HEX HEX HEX HEX
        ;

fragment HEX
        : [0-9a-fA-F]
        ;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-of-fluentpath-in-hl7-fhir">Appendix B: Use of FluentPath in HL7 FHIR</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FluentPath is used in five places in the FHIR specifications:
- search parameter paths - used to define what contents the parameter refers to
- slicing discriminator - used to indicate what element(s) define uniqueness
- invariants in ElementDefinition, used to apply co-occurrence and other rules to the contents
- error message locations in OperationOutcome
- URL templates in Smart on FHIR&#8217;s cds-hooks
- may be used for Patch in the future</p>
</div>
<div class="paragraph">
<p>As stated in the introduction, FluentPath uses a tree model that abstracts away the actual underlying datamodel of the data being queried. For FHIR, this means that the contents of the resources and data types as described in the Logical views (or the UML diagrams) are used as the model, rather than the JSON and XML formats, so specific xml or json features are not visible to the FluentPath language (such as comments and the split representation of primitives).</p>
</div>
<div class="paragraph">
<p>More specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A FluentPath may optionally start with a full resource name</p>
</li>
<li>
<p>Elements of datatypes and resources are used as the name of the nodes which can be navigated over, except for choice elements (ending with '[x]'), see below.</p>
</li>
<li>
<p>The <code>contained</code> element node does not have the name of the Resource as its first and only child (instead it directly contains the contained resource&#8217;s children)</p>
</li>
<li>
<p>There is no difference between an attribute and an element</p>
</li>
<li>
<p>Repeating elements turn into multiple nodes with the same name</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="polymorphism-in-fhir">B.1. Polymorphism in FHIR</h3>
<div class="paragraph">
<p>FHIR has the notion of choice elements, where elements can be one of multiple types, e.g. <code>Patient.deceased[x]</code>. In actual instances these will be present as either <code>Patient.deceasedBoolean</code> or <code>Patient.deceasedDateTime</code>. In FluentPath choice elements are labeled according to the name without the '[x]' suffix, and children can be explicitly filtered using the <code>as</code> operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Observation.value.as(Quantity).unit</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-fhir-types-in-expressions">B.2. Using FHIR types in expressions</h3>
<div class="paragraph">
<p>The evaluation engine will automatically convert the value of FHIR types representing primitives to FluentPath types when they are used in expression in the following fashion:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">FHIR primitive type</th>
<th class="tableblock halign-left valign-top">FluentPath type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string, uri, code, oid, id, uuid, sid, markdown, base64Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">integer, unsignedInt, positiveInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">decimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">decimal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">date, dateTime, instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that FHIR primitives may contain extensions, so that the following expressions are <em>not</em> mutually exclusive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given = 'Ewout'         // value of Patient.name.given as a string
Patient.name.given.extension.first().value = true   // extension of the primitive value</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="additional-functions">B.3. Additional functions</h3>
<div class="paragraph">
<p>FHIR adds (backwards compatible) functionality to the common set of functions:</p>
</div>
<div class="sect3">
<h4 id="extension-url-string-collection">B.3.1. extension(url : string) : collection</h4>
<div class="paragraph">
<p>Will filter the focus for items named "extension" with the given url. This is a syntactical shortcut for <code>.extension.where(url = string)</code>, but is simpler to write. Will return an empty collection if the focus is empty or the url is empty.</p>
</div>
</div>
<div class="sect3">
<h4 id="trace-name-string-collection-2">B.3.2. trace(name : string) : collection</h4>
<div class="paragraph">
<p>When FluentPath statements are used in an invariant, the log contents should be added to the
error message constructed when the invariant is violated. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>"SHALL have a local reference if the resource is provided inline (url: height; ids: length,weight)"

from

"reference.startsWith('#').not()
    or ($context.reference.substring(1).output('url') in $resource.contained.id.output('ids'))"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="resolve-collection">B.3.3. resolve() : collection</h4>
<div class="paragraph">
<p>For each item in the collection, if it is a string, locate the target of the reference, and add it to the resulting collection. If the item is not a string, the item is ignored and nothing is added to the output collection.</p>
</div>
<div class="paragraph">
<p>The items in the collection may also represent a Reference, in which case the <code>Reference.reference</code> is resolved.</p>
</div>
<div class="paragraph">
<p>If fetching the resource fails, the failure message is added to the output collection.</p>
</div>
</div>
<div class="sect3">
<h4 id="oftype-type-identifier-collection-2">B.3.4. ofType(type : identifier) : collection</h4>
<div class="paragraph">
<p>In FHIR, only concrete core types are allowed as an argument. All primitives are considered to be independent types (so <code>markdown</code> is <strong>not</strong> a subclass of <code>string</code>). Profiled types are not allowed, so to select <code>SimpleQuantity</code> one would pass <code>Quantity</code> as an argument.</p>
</div>
</div>
<div class="sect3">
<h4 id="elementdefinition-collection">B.3.5. elementDefinition() : collection</h4>
<div class="paragraph">
<p>Returns the FHIR element definition information for each element in the input collection.</p>
</div>
</div>
<div class="sect3">
<h4 id="slice-structure-string-name-string-collection">B.3.6. slice(structure : string, name : string) : collection</h4>
<div class="paragraph">
<p>Returns the given slice as defined in the given structure definition. The structure argument is a uri that resolves to the structure definition, and the name must be the name of a slice within that structure definition. If the structure cannot be resolved, or the name of the slice within the resolved structure is not present, an error is thrown.</p>
</div>
<div class="paragraph">
<p>For every element in the input collection, if the resolved slice is present on the element, it will be returned. If the slice does not match any element in the input collection, or if the input collection is empty, the result is an empty collection (<code>{ }</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="checkmodifiers-modifier-string-collection">B.3.7. checkModifiers([{modifier : string}]) : collection</h4>
<div class="paragraph">
<p>For each element in the input collection, verifies that there are no modifying extensions defined other than the ones given by the <code>modifier</code> argument. If the check passes, the input collection is returned. Otherwise, an error is thrown.</p>
</div>
</div>
<div class="sect3">
<h4 id="conformsto-structure-string-boolean">B.3.8. conformsTo(structure : string) : boolean</h4>
<div class="paragraph">
<p>Returns <code>true</code> if the single input element conforms to the profile specified by the <code>structure</code> argument, and false otherwise. If the structure cannot be resolved to a valid profile, an error is thrown. If the input contains more than one element, an error is thrown. If the input is empty, the result is empty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="changes-to-operators">B.4. Changes to operators</h3>
<div class="sect3">
<h4 id="equivalence">B.4.1. ~ (Equivalence)</h4>
<div class="paragraph">
<p>Equivalence works in exactly the same manner, but with the addition that for complex types, equality requires all child properties to be equal, <strong>except for "id" elements</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="in-membership-2">B.4.2. in (Membership)</h4>
<div class="paragraph">
<p>Membership works in the same way, with the added capability that if the argument is a string, it is resolved as a uri to a value set and the operation performs value set membership.</p>
</div>
<div class="paragraph">
<p>Note that implementations are encouraged to make use of a terminology service to provide this functionality.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="environment-variables-2">B.5. Environment variables</h3>
<div class="paragraph">
<p>The FHIR specification adds support for additional environment variables:</p>
</div>
<div class="paragraph">
<p>The following environmental values are set for all contexts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>%sct        - (string) url for snomed ct
%loinc      - (string) url for loinc
%"vs-[name]" - (string) full url for the provided HL7 value set with id [name]
%"ext-[name]" - (string) full url for the provided HL7 extension with id [name]
%resource	- The original resource current context is part of.
 			  When evaluating a datatype, this would be the resource the element is part of. Do not go past a root resource into a bundle, if it is contained in a bundle

Note how the names of the `vs-` and `ext-` constants are escaped (just like paths) to allow "-" in the name.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementation Guides are allowed to define their own externals, and implementers should provide some appropriate configuration framework to allow these constants to be provided to the evaluation engine at run time. E.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>%us-zip = '[0-9]{5}(-[0-9]{4}){0,1}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Authors of Implementation Guides should be aware that adding specific environment variables restricts the use of the FluentPath to their particular context.</p>
</div>
<div class="paragraph">
<p>Note that these tokens are not restricted to simple types, and they may have fixed values that are not known before evaluation at run-time, though there is no way to define these kind of values in implementation guides.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-of-fluentpath-in-clinical-quality-language-cql">Appendix C: Use of FluentPath in Clinical Quality Language (CQL)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clinical Quality Language is being extended to use FluentPath as its core path language, in much the same way that XQuery uses XPath to represent paths within queries. In particular, the following extensions to CQL are proposed:</p>
</div>
<div class="sect2">
<h3 id="path-traversal">C.1. Path Traversal</h3>
<div class="paragraph">
<p>When a path expression involves an element with multiple cardinality, the expression is considered short-hand for an equivalent query invocation. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.telecom.use</code></pre>
</div>
</div>
<div class="paragraph">
<p>is allowed, and is considered a short-hand for the following query expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.telecom X where X.use is not null return X.use</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given a patient with multiple telecom entries, the above query will return a list containing the <code>use</code> element from each entry. Note that the restriction is required as it ensures that the resulting list will not contain any <code>null</code> elements. In addition, if the element itself is list-valued, the result is expanded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given</code></pre>
</div>
</div>
<div class="paragraph">
<p>is short-hand for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>expand (Patient.name X where X.given is not null return (X.given Y where Y is not null))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, given a patient with multiple names, each of which has multiple givens, this will return a single list containing all the given names in all the names.</p>
</div>
</div>
<div class="sect2">
<h3 id="constants-and-contexts">C.2. Constants and Contexts</h3>
<div class="paragraph">
<p>FluentPath has the ability to reference contexts (using the <code>$</code> prefix) and environment-defined variables (using the <code>%</code> prefix). Within CQL, these contexts and environment-defined variables are added to the appropriate scope (global for environment-variables, local for contexts) without the prefix. Additionally, because the <code>%</code> prefix is optional, it is not required to access environment-defined variables within CQL.</p>
</div>
</div>
<div class="sect2">
<h3 id="additional-operators">C.3. Additional Operators</h3>
<div class="paragraph">
<p>The following additional operators are being added to CQL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>~</code>, <code>!~</code> - Equivalent operators (formerly <code>matches</code> in CQL)</p>
</li>
<li>
<p><code>!=</code> - As a replacement for <code>&lt;&gt;</code></p>
</li>
<li>
<p><code>implies</code> - Logical implication</p>
</li>
<li>
<p><code>|</code> - As a synonym for <code>union</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="method-style-invocation">C.4. Method-style Invocation</h3>
<div class="paragraph">
<p>One of the primary syntactic features of FluentPath is the ability to "invoke" a function on a collection. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.given.substring(3)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CQL syntax is being extended to support this style of invocation, but as a short-hand for an equivalent CQL statement for each operator. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>stringValue.substring(3, 5)</code></pre>
</div>
</div>
<div class="paragraph">
<p>is allowed, and is considered a short-hand for the following CQL expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Substring(stringValue, 3, 5)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For most functions, this short-hand is a simple rewrite, but for contextual functions such as <code>where()</code> and <code>select()</code>, this rewrite must preserve the context semantics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name.where(given = 'John')</code></pre>
</div>
</div>
<div class="paragraph">
<p>is short-hand for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Patient.name N where N.given = 'John'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="strict-evaluation">C.5. Strict Evaluation</h3>
<div class="paragraph">
<p>Because CQL is a type-safe language, embedded FluentPath expressions should be compiled in <em>strict</em> mode. However, to enable the use of FluentPath in <em>loose</em> mode, an implicit conversion from a list of elements to an element is added. This implicit conversion is implemented as an invocation of <code>singleton from</code>, ensuring that if the list has multiple elements at run-time an error will be thrown.</p>
</div>
<div class="paragraph">
<p>In addition, the underlying Expression Logical Model (ELM) is being extended to allow for dynamic invocation. A <code>Dynamic</code> type is introduced with appropriate operators to support run-time invocation where necessary. However, these operators are introduced as an additional layer on top of core ELM, and CQL compiled with the <em>strict</em> option will never produce expressions containing these elements. This avoids placing additional implementation burden on systems that do not need dynamic capabilities.</p>
</div>
</div>
</div>
</div>


</div>


				</div>  <!-- /inner-wrapper -->
            </div>  <!-- /row -->
        </div>  <!-- /container -->
        
    </div>  <!-- /segment-content -->


	<div id="segment-footer" class="segment">  <!-- segment-footer -->
		<div class="container">  <!-- container -->
			<div class="inner-wrapper">
				<p>
        &copy; HL7.org 2014+. FluentPath STU1 Ballot (0.3.0) generated on 2016-08-05 16:29:28 +1000
        <span style="color: #FFFF77">| 
               <a style="color: #81BEF7" rel="license" href="http://hl7.org/fhir/2016May/license.html"><img style="border-style: none;" alt="CC0" src="../dist/cc0.png"></a> | 
               <a style="color: #81BEF7" target="_blank" href="http://gforge.hl7.org/gf/project/fhir/tracker/?action=TrackerItemAdd&amp;tracker_id=677">Propose a change</a>   
        </span>
        </p>
			</div>  <!-- /inner-wrapper -->
		</div>  <!-- /container -->
	</div>  <!-- /segment-footer -->

	
	<div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
		<div class="container">  <!-- container -->
		</div>  <!-- /container -->
	</div>  <!-- /segment-post-footer -->
    
      <!-- JS and analytics only. -->
      <!-- Bootstrap core JavaScript
================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
<script src="../dist/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
<script src="../dist/bootstrap.min.js"> </script>
<script src="../dist/respond.min.js"> </script>

<script src="../dist/fhir.js"> </script>

  <!-- Analytics Below
================================================== -->


<div id="feedly-mini" title="feedly Mini tookit"></div></body></html>